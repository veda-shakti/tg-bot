name: Deploy to Production Server

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BOT_TOKEN: ${{ secrets.SHAKTI_BOT }}
      ADMIN_ID: ${{ secrets.ADMIN_ID }}

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create Directory Snapshot
      run: |
        mkdir snapshot
        rsync -av --exclude='.git' --exclude='.github' ./ snapshot/

    - name: Archive production artifacts
      run: |
        set -euxo pipefail
        tar -czvf packaged-code.tar.gz -C snapshot .
    - uses: actions/upload-artifact@v3
      with:
        name: packaged-code
        path: packaged-code.tar.gz

    - name: Send Telegram Notification on Archive Failure
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üö® [–ë–æ—Ç][1/2] –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏.
          *Ô∏è‚É£ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–¥–µ—Å—å: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Send Telegram Notification on Archive Success
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: "‚úÖ [–ë–æ—Ç][1/2] –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

  deploy:
    needs: build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: packaged-code

    - name: Install lftp for SFTP
      run: sudo apt-get install lftp

    - name: SFTP Deploy
      run: |
        lftp -e "
        set ssl:verify-certificate no;
        set sftp:auto-confirm yes;
        open sftp://devilaks@devilaks.ftp.tools;
        user ${{ secrets.SFTP_USERNAME }} ${{ secrets.SFTP_PASSWORD }};
        lcd ./;
        cd /home/devilaks/bot;
        mirror --reverse --continue --verbose --parallel=10 . .;
        bye;
        "

    - name: SSH and Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          export SHAKTI_BOT="${{ secrets.SHAKTI_BOT }}"
          export ADMIN_ID="${{ secrets.ADMIN_ID }}"
          cd /home/devilaks/bot
          ./stop.sh

          if [ -f packaged-code.tar.gz ]; then
            echo "Found packaged-code.tar.gz. Proceeding to extract it"
            tar -xzvf packaged-code.tar.gz
            rm --force packaged-code.tar.gz
          else
            echo "No packaged-code.tar.gz file found. Exiting script"
            exit 1
          fi

          nohup ./run_bot.sh > bot.log 2>&1 &
          echo "Bot process started"

    - name: Send Telegram Notification on Deploy Failure
      if: failure()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          üö® [–ë–æ—Ç][2/2] –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏.
          *Ô∏è‚É£ –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–¥–µ—Å—å: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Send Telegram Notification on Deploy Success
      if: success()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: "üöÄ [–ë–æ—Ç][2/2] –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç–∞: @anastasia_shakti_bot"
